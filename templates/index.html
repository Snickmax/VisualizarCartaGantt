{% extends "layout.html" %}
{% block content %}
<section class="card">
  <h2 style="display:flex;align-items:center;gap:8px;margin-top:0">
    <span class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M19 15a4 4 0 0 0-3.8-4A5.5 5.5 0 0 0 5 9.5 4.5 4.5 0 0 0 5.5 18H9v-2H5.5A2.5 2.5 0 0 1 3 13.5 3.5 3.5 0 0 1 6.5 10 3.5 3.5 0 0 1 10 6.5 4.5 4.5 0 0 1 14.5 11H15a3 3 0 0 1 0 6h-2v2h2a5 5 0 0 0 0-10z"/><path d="M11 16h2V9h2l-3-3-3 3h2z"/></svg>
    </span>
    Cargar archivo Excel
  </h2>

  <p class="muted" style="margin-top:6px">
    La planilla debe contener, al menos, las columnas:
  </p>
  <ul class="help-list">
    <li><code>ID</code></li>
    <li><code>Tarea</code></li>
    <li><code>Inicio Planificado</code></li>
    <li><code>Fin Planificado</code></li>
    <li><code>Predecesor</code></li>
    <li><code>Inicio Real</code></li>
    <li><code>Fin Real</code></li>
  </ul>

  <!-- Dropzone -->
  <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Subir archivo Excel">
    <div class="dz-inner">
      <span class="icon big" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2zm-7-9l5 5h-3v6h-4V9H7l5-5zM5 18h14v2H5v-2z"/></svg>
      </span>
      <div class="dz-title">Arrastra y suelta tu Excel aquí</div>
      <div class="dz-hint">o</div>
      <div>
        <button type="button" class="btn secondary" id="chooseBtn">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M19 2H8a2 2 0 0 0-2 2v3h2V4h11v16H8v-3H6v3a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/><path d="M3.5 7H6l2.5 5L6 17H3.5l2-5-2-5zm6 0h2l1.5 3 1.5-3h2l-2.5 5L16.5 17h-2l-1.5-3-1.5 3h-2l2.5-5L9.5 7z"/></svg>
          </span>
          <span>Seleccionar Excel</span>
        </button>
      </div>
      <div id="filePill" class="file-pill" hidden></div>
      <div class="dz-note">Formatos permitidos: <strong>.xlsx</strong>, <strong>.xls</strong> • Máx. 20MB</div>
    </div>
  </div>

  <!-- Form real (oculto input, submit con spinner) -->
  <form id="uploadForm" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" class="upload-form" style="margin-top:12px">
    <input id="fileInput" type="file" name="file" accept=".xlsx,.xls" required hidden>
    <button id="submitBtn" type="submit" class="btn" disabled>
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zm7-18v10.59l3.3-3.3 1.4 1.42L12 16.41l-4.7-4.7 1.4-1.42 3.3 3.3V2z"/></svg>
      </span>
      <span>Subir y procesar</span>
    </button>
    <a class="btn ghost" href="{{ url_for('index') }}">
      <span class="icon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M10 20v-6H3l9-9 9 9h-7v6z"/></svg>
      </span>
      <span>Reiniciar</span>
    </a>
  </form>

  <p class="hint" style="margin-top:10px">
    ¿Sin datos a mano? Prueba con el ejemplo:
    <a href="{{ url_for('static', filename='sample_data/simulacion1_1_1.xlsx') }}">
      <span class="icon" aria-hidden="true" style="vertical-align:-2px;margin-right:4px">
        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8l-6-6zM8 14h2a2 2 0 1 0 0-4H8v4zm6 0h2v-4h-2v4zM8 18h8v-2H8v2zm6-11.5V8h3.5L14 6.5z"/></svg>
      </span>
      simulacion1_1_1.xlsx
    </a>
  </p>
</section>

<script>
  (function(){
    const drop = document.getElementById('dropzone');
    const chooseBtn = document.getElementById('chooseBtn');
    const input = document.getElementById('fileInput');
    const pill = document.getElementById('filePill');
    const submit = document.getElementById('submitBtn');
    const form = document.getElementById('uploadForm');
    const MAX = 20 * 1024 * 1024;

    function showFile(file){
      pill.textContent = file.name + ' · ' + (Math.round(file.size/1024)/1024).toFixed(2) + ' MB';
      pill.hidden = false;
      submit.disabled = false;
    }

    function valid(file){
      if (!file) return false;
      if (!/\.(xlsx|xls)$/i.test(file.name)) { alert('Formato no permitido. Usa .xlsx o .xls'); return false; }
      if (file.size > MAX) { alert('El archivo supera 20MB'); return false; }
      return true;
    }

    function setFile(file){
      if (!valid(file)) return;
      // setear programáticamente el input
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      showFile(file);
    }

    // Click/keyboard
    drop.addEventListener('click', () => input.click());
    drop.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
    });
    chooseBtn.addEventListener('click', () => input.click());
    input.addEventListener('change', (e) => setFile(e.target.files[0]));

    // Drag & drop
    ['dragenter','dragover'].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dz-in'); });
    });
    ['dragleave','drop'].forEach(ev => {
      drop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dz-in'); });
    });
    drop.addEventListener('drop', (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) setFile(f);
    });

    // Submit: bloquear y mostrar spinner
    form.addEventListener('submit', () => {
      submit.disabled = true;
      submit.innerHTML = `
        <span class="icon spin" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1 1 1 0 0 1-1 1A8 8 0 1 0 20 12a1 1 0 0 1 2 0 10 10 0 1 1-10-10z"/></svg>
        </span>
        <span>Procesando…</span>`;
    });
  })();
</script>
{% endblock %}
